function [output,Xf,Af] = EncDec3LayersWdelays_f(netObj,X,~,Ai,op_type)
%TESTFNEW neural network simulation function.
%
% Generated by Neural Network Toolbox function genFunction, 19-Nov-2018 14:13:10.
%
% [Y,Xf,Af] = testFnew(X,~,Ai) takes these arguments:
%
%   X = 1xTS cell, 1 inputs over TS timesteps
%   Each X{1,ts} = 18xQ matrix, input #1 at timestep ts.
%
%   Xi = 1x0 cell 1, initial 0 input delay states.
%   Each Xi{1,ts} = 18xQ matrix, initial states for input #1.
%
%   Ai = 3x25 cell 3, initial 0 layer delay states.
%   Each Ai{1,ts} = 5xQ matrix, initial states for layer #1.
%   Each Ai{2,ts} = 5xQ matrix, initial states for layer #2.
%   Each Ai{3,ts} = 9xQ matrix, initial states for layer #3.
%
% and returns:
%   Y = 1xTS cell of 1 outputs over TS timesteps.
%   Each Y{1,ts} = 9xQ matrix, output #1 at timestep ts.
%
%   Xf = 1x0 cell 1, final 0 input delay states.
%   Each Xf{1,ts} = 18xQ matrix, final states for input #1.
%
%   Af = 3x25 cell 3, final 25 layer delay states.
%   Each Af{1ts} = 5xQ matrix, final states for layer #1.
%   Each Af{2ts} = 5xQ matrix, final states for layer #2.
%   Each Af{3ts} = 9xQ matrix, final states for layer #3.
%
% where Q is number of samples (or series) and TS is the number of timesteps.

%#ok<*RPMT0>

% ===== NEURAL NETWORK CONSTANTS =====

% % Layer 1
% b1 = [-0.31215568549130789933;-0.49843737264713272594;-0.69827261415772501341;-0.13519599154936792762;-0.80234944126651464025];
% IW1_1 = [0.19297138451097287093 -0.036126777014034869295 -0.76027581869292593097 0.26655690932899772649 0.65427094708606137186 0.17915185571597280756 0.56877058710094685612 1.8965807979221565027 0.079148857172990305653 0.055726721632244069493 0.14308032188008115715 0.35971341917709404035 0.026040521343354487704 1.1718004547706555307 0.035264247805618341436 0.26233188576209776066 0.65937547320392864147 0.055531574787606299837;0.26557714390539016724 -0.3568614035876411239 -1.5105443601669694687 -0.09514512556213521044 -2.3303683504339192112 0.054391322840777509007 -0.40711847188718741641 0.84662129812081532432 0.69640131110394021263 -0.13703744884034327334 0.027489612839144771106 0.48832403647814670578 -0.092426482608903640092 0.68726913720885118853 -0.12585193597759133932 -0.18735640060915745297 -0.062859578830175996678 -0.12187346583046738957;1.7254998690259442107 1.4868305214397967706 -0.2720418645394475643 0.28486832491385022381 -0.70594570780426146861 1.4874838865924320253 2.5059246719768206724 -2.9366472935412195611 1.6256386388139474342 -0.39124096874687575021 -0.020210664313457402108 0.33454743834640243705 -0.20400460215586488366 -1.7795292507067275167 -0.369033663272747392 -1.2182592050009679596 -1.2158817172536151574 -0.42781128935867535068;0.26532002102557439294 -0.44747231932555925349 -1.8111761813055029524 -0.029382410997090793042 1.5666134870605701312 0.093305769793083984109 -0.10643940671651197505 -0.72384466865097774058 -0.24797373249751530899 -0.060720071161657153402 -0.067909980887735005295 0.48259030112854783834 -0.1194818774016226659 -0.76400802228806885541 -0.045151964043360498513 0.5841466186546747652 0.25340581623825181312 -0.097514889926445330603;1.0622028521587643102 1.3194988480479554749 -0.12479163030544392077 0.40714301000147795628 -2.9899085102697320337 1.1291502982238106334 1.7662704447373069883 -5.2107411281485296328 0.94988533081544079817 0.16307124802504335825 0.063452349637030461271 -0.078215309311017458538 0.09230395245354322542 1.9842949628405897045 0.15914120648670224134 0.49396590579260368781 1.7906003577286442319 0.18589425937768797037];
%
% % Layer 2
% b2 = [-1.4225652350105781885;-0.06921070819264081575;0.25835348229223048522;-0.62924978214726112746;1.0512476656437901301];
% LW2_1 = [0.75199104798802718364 0.43146062671952617462 -0.82704642229989855373 -0.11594814812543725868 2.831070141763542658;-0.52456264201453861595 2.1690108352378585366 0.020330168795514358404 -1.9364092752960728738 0.3829437605095375452;0.27381441015870822131 -1.205133182192965613 0.80579925164612908883 -1.1229728441510364867 0.13021812648620970099;-1.2259752728290480572 0.24089346591862084712 2.3059822622557017979 1.4362933957518144723 -2.0205775360922171302;-2.1625611657257901577 -0.73798012366958143371 -0.64158463880057270412 -0.29060406825750456639 0.24932211370311224696];
%
% % Layer 3
% b3 = [0.034284670542111456149;0.058947936249577614909;0.1078594149626822124;0.020660429529693651041;-0.1587622532172821288;0.033787117163057128755;0.075229443910364832138;-0.34468096429553651827;0.026291221690469320643];
% LW3_2 = [0.049989635150528101415 0.040702897700460059782 0.14063600733110118157 0.13288732600515323901 -0.1753066063061086699 0.005863482101141704976 0.0027286475214478621634 0.0020001308249097881839 0.011276920415243666881 -0.016658021232053940586 -0.0039148332820744665903 0.00079424258797878525152 0.0020063810607785018125 -0.0037099995907889384526 0.0087940503583182460384 -0.00071260284789644663585 9.3209970377963768419e-05 -0.00041422154417748978947 -0.00039262469133909746067 0.0014923266734563728989;-0.032993263763902512531 0.050800661388849283062 0.30091492090243782132 0.026299752994731816907 -0.097425143252575271968 0.011002840738598081843 0.006184511901492743477 0.021710897227704386431 0.031073520724501126067 -0.029812806038591346119 0.0058199521864268919172 0.0032627697650241226091 -0.0050853301239949339971 0.010731488394636360881 -0.019247764918618751051 -0.0019318038756863612632 0.0020067517963811777777 -0.018857733854334281925 -0.0068963050575599630157 0.016229390907542218248;-0.2409044862796163311 0.061871279837661032064 0.62387054301888111851 -0.28457341893941734412 0.17788868243578556672 0.001725785320747698446 0.0010891253718306951725 -0.004491006147524969315 0.00093015564286829961055 -0.0057152632440311511297 -0.0015752522579247447889 -0.0012266197126379889577 -0.0027184083926168074036 -0.0036434289990659755529 0.008689168922548711621 0.00075541458111158901224 -0.0010147299188576369179 0.0047070604844574115769 0.0022680130843429368616 -0.0043837223848011055288;-0.0038120309930398496752 0.022443056622976916004 0.11005646250989216395 0.02360786874282951725 -0.053582118478508015957 0.00034470811301414772988 0.00066619310446541476264 0.023936635447910612623 0.0018478450788198339926 -0.018272173336721712206 -0.0023477774364035635703 0.0017828024811443112397 0.010742006210385209378 -0.00039343229561435036443 -0.0031385948511626067352 0.0034429622689451356253 -0.00025092098796880389763 -0.017689487840304541494 0.0039821242527682742737 0.0036219455194983116685;0.0019104419872855446863 -0.46942978939601992527 0.099664034474518589657 -0.084667946773436600361 -0.12404712425738571857 -0.00077251087277823522401 0.0074491755469053315061 0.0092283048639661552359 0.004089649430836478361 -0.011026847530073729045 -0.0016534965948877089308 0.0015415894053824577472 -0.002444891601383863966 -0.0041926811575998014503 0.0026387262225993864985 0.00014347230640008914993 -0.00085867178524790400539 -9.265758059951175016e-05 -0.00023495642682837307924 0.00057397980195508823461;0.047574449474279856265 0.032127615651751720294 0.12908233389414913717 0.12309126322263212738 -0.15844027743752928106 0.0064277338676716191598 0.00061936757606976947706 0.0014650805078694655644 0.011713622802339930529 -0.014672993874574588591 -0.0039023634682753445546 -0.00023311131935220062001 0.0013215584088557366139 -0.004793391831729909916 0.011330612006951939347 -0.00035565566494273127048 8.5829677719234892617e-05 -0.00078437929021650998253 0.0013407190955610568794 0.0018616566862885604305;-0.0026526636982353492961 0.062682255407676801262 0.449189007843967536 0.10722243662123370767 -0.23512919651135014143 -0.014050593915083172541 -0.011836680667436948189 -0.019899829682400872743 -0.037420386383980958067 0.045173989954054957763 0.00099556781645578616181 -0.0013587985813920593157 0.015494706760000453646 0.0057073494573985578474 -0.010586964382175259244 -0.0027397630761485242123 0.0020194132744169187264 0.014764981420089272335 -0.00078938962998736786954 -0.0067434773859066741292;-0.28414486338065586546 0.088585160049089922696 0.15038670736775877623 -0.34002896873743454487 -0.52020628186820383476 -0.0051125161531179168922 0.0083653438777449070501 0.0050088109644566948878 0.0039889036326460694526 0.00039706847393667212085 -0.0020531812764060077339 0.0044395042349884752259 -0.0042752798740334609431 -0.0044021322879408339435 -0.0021278427591455940579 0.0020219694806247307493 -0.0029005596067174241673 -0.0095167429387505008548 -0.00046103728983305227677 0.0061476623336751924295;0.036857550570202499141 0.078246133638823434087 0.13234973220795642757 0.12363790325967152772 -0.18855763817487458667 -0.0019627981173716215098 0.013743297191236803975 0.0076124153001916371533 0.0035485095612799548437 -0.017394402594639511023 -0.0012666806331028575283 -0.0018347842877857796929 -0.00036018342304108098362 -0.0049293987121772553026 0.0080990375557341617169 -0.0015030884316904590675 0.0014943094374178676406 0.010328250585879940673 -2.8015894861773001871e-05 -0.0070065262412615835277];

timeDelays = netObj.layerWeights{3,2}.delays;

% ===== SIMULATION ========

% Format Input Arguments
isCellX = iscell(X);
if ~isCellX
    X = {X};
end
if (nargin < 3), error('Initial input states Ai argument needed.'); end

% Dimensions
TS = size(X,2); % timesteps
if ~isempty(X)
    Q = size(X{1},2); % samples/series
elseif ~isempty(Ai)
    Q = size(Ai{1},2);
else
    Q = 0;
end
if isempty(Ai)
    Ai=cell(3,25);
    Ai(1,:) = {zeros(5,Q)};
    Ai(2,:) = {zeros(5,Q)};
    Ai(3,:) = {zeros(9,Q)};
end

% Layer Delay States
Ad1 = [Ai(1,:) cell(1,1)];
Ad2 = [Ai(2,:) cell(1,1)];
Ad3 = [Ai(3,:) cell(1,1)];


% encoder bias and weights
b1 = netObj.b{1};
IW1_1 = netObj.IW{1,1};
% decoder bias and weights
b2 = netObj.b{2};
LW2_1 =  netObj.LW{2,1};
b3 = netObj.b{3};
LW3_2 = netObj.LW{3,2};

highestDelay = timeDelays(end);


% Allocate Outputs
Y = cell(1,TS);
output = cell(1,TS);

% Time loop
for ts=1:TS
    
    % Rotating delay state position
    adts = mod(ts+highestDelay-1,highestDelay+1)+1;
    
    % Input 1
    % no processing
    if strcmp(op_type,'encode') % when used for encoding
        % Layer 1
        Ad1{adts} = tansig_apply(repmat(b1,1,Q) + IW1_1*X{1,ts});
        % encodedData(:,ts) = Ad1{adts};
        output{1,ts} = Ad1{adts};
        
    elseif strcmp(op_type,'decode') % when using for decoding
        % Layer 2
        Ad1{adts} = X{1,ts};
        tapdelay1 = cat(1,Ad1{mod(adts-0-1,highestDelay+1)+1});
        Ad2{adts} = repmat(b2,1,Q) + LW2_1*tapdelay1;
        
        % Layer 3
        tapdelay1 = cat(1,Ad2{mod(adts-timeDelays-1,highestDelay+1)+1});
        Ad3{adts} = repmat(b3,1,Q) + LW3_2*tapdelay1;
        
        % Output 1
        output{1,ts} = Ad3{adts};
        
    end % if encoding/decoding
end

% Final Delay States
finalats = TS+(1: highestDelay);
ats = mod(finalats-1,highestDelay+1)+1;
Xf = cell(1,0);
Af = cell(3,highestDelay);
Af(1,:) = Ad1(:,ats);
Af(2,:) = Ad2(:,ats);
Af(3,:) = Ad3(:,ats);

% Format Output Arguments
if ~isCellX
    output = cell2mat(output);
end
end % function

